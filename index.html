<!DOCTYPE html>
<html>
<head>
    <title>SOMETHING</title>
    <link rel="stylesheet" href="stylesheet.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.3.11/d3.min.js"></script>
</head>

<body>

<ul>
    <li><h1 id="year-all"> ALL </h1></li>
    <li><h1 id="year-2013" class="selected-year"> 2013 </h1></li>
    <li><h1 id="year-2012"> 2012 </h1></li>
    <li><h1 id="year-2011"> 2011 </h1></li>
    <li><h1 id="year-2010"> 2010 </h1></li>
    <li><h1 id="year-2009"> 2009 </h1></li>
</ul>

<div class="clear"></div>

<svg id="books-2013"></svg>

<div id="stats">
    <h2 id ="book-count"></h2>
    <h2 id ="book-page-num"></h2>
    <h2 id ="book-rate-min"></h2>
    <h2 id ="book-rate-max"></h2>
    <h2 id ="book-rate-avg"></h2>
    <div id="current">
        <img id="book-image" src=""> </img>
        <p id="book-title"></p>
        <p id="book-author"></p>
        <p id="book-num_pages"></p>
    </div>
</div>


<script> 
var h = 500,
    w = 500,
    margin = 15,
    cols = 10;

var svg = d3.select('#books-2013')
    .attr('height', h)
    .attr('width', w);

//Scale
var x = d3.scale.linear().domain([0,cols]).range([margin, w - margin]);
var y = d3.scale.linear().domain([0,12]).range([margin, h - margin]);
var color = d3.scale.linear().domain([0, 700]).range(['#FFB6C1','#7D1717']);

var books = null;

d3.json('books.json', function(err,data){
    books=data;
    drawYear(2013,books[2013]);
})

function drawYear(year, data) {
    d3.selectAll('h1').attr('class', "")
    d3.select("#year-"+year).attr('class',"selected-year");

    d3.select('#book-count').text("Total books: "+data.meta.count);
    d3.select('#book-page-num').text("Total pages: "+data.meta.pages);
    d3.select('#book-rate-min').text("Worst Rated Book (Goodreads): "+data.meta.rating.min);
    d3.select('#book-rate-max').text("Best Rated Book (Goodreads): "+data.meta.rating.max);
    d3.select('#book-rate-avg').text("Average Goodreads Rating: "+data.meta.rating.avg);

    var data = svg.selectAll('circle')
        .data(data.books, function(d,idx){
            return d.title + "-" + d.year;
        });
        data.exit().remove()
        data.enter()//any new datapoint
        .append('circle')
            .attr('r', 10)
            .attr('cx', function(d, idx){ //d is a book (special coloring would go here), idx is the index
                return x(idx % cols);
            })
            .attr('cy', function(d,idx){
                return y(Math.floor(idx / cols));
            })
            .attr('fill', function(d){
                return color(d.num_pages);

            })
            .on('mouseover',function(d){
                d3.select('#book-title').text(d.title);
                d3.select('#book-image').attr('src', d.image_url);
                d3.select('#book-author').text("by " + d.author);
                d3.select('#book-num_pages').text(d.num_pages + " pages");
                d3.select(this).attr('fill', 'red');
            })

            .on('mouseout', function(d){
                d3.select(this).attr('fill', color(d.num_pages));
            });


    console.log(books);
}


d3.select('#year-all').on('click',function(){
    if (!books['all']){
        books['all'] = {
            meta: {
                count: 0,
                pages: 0,
                rating: {
                    min: null,
                    avg: 0,
                    max: null,
                }
            },
            books: []
        };

        [2009,2010,2011,2012,2013] .forEach(function(year){
            books.all.meta.pages += books[year].meta.pages
            books.all.meta.count += books[year].meta.count
            books.all.books = books.all.books.concat(books[year].books)
        })
        


    }
    drawYear('all', books['all'])

})

d3.select('#year-2013').on('click',function(){ drawYear(2013,books[2013]); });
d3.select('#year-2012').on('click',function(){ drawYear(2012,books[2012]); });
d3.select('#year-2011').on('click',function(){ drawYear(2011,books[2011]); });
d3.select('#year-2010').on('click',function(){ drawYear(2010,books[2010]); });
d3.select('#year-2009').on('click',function(){ drawYear(2009,books[2009]); });

</script>
</body>
</html>