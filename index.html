<!DOCTYPE html>
<html>
<head>
    <title>SOMETHING</title>
    <link rel="stylesheet" href="stylesheet.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.3.11/d3.min.js"></script>
</head>

<body>

<div id="navigation">
    <ul>
        <li><h1 id="year-all"> All </h1></li>
        <li><h1 id="year-2013" class="selected-year"> 2013 </h1></li>
        <li><h1 id="year-2012"> 2012 </h1></li>
        <li><h1 id="year-2011"> 2011 </h1></li>
        <li><h1 id="year-2010"> 2010 </h1></li>
        <li><h1 id="year-2009"> 2009 </h1></li>
        <li><h1 id="year-2008"> 2008 </h1></li>
        <li><h1 id="year-pre-2008"> pre-2008 </h1></li>
        <li><h1 id="fiction"> Fiction </h1></li>
        <li><h1 id="non-fiction"> Nonfiction </h1></li>
        <li><h1 id="female-author">Female Author</h1></li>
        <li><h1 id="male-author">Male Author</h1></li>
    </ul>
</div>

<svg id="books-2013"></svg>

<div id="current">
    <img id="book-image" src=""> </img>
    <p id="book-title"></p>
    <p id="book-author"></p>
    <p id="book-num_pages"></p>
    <div id="stats">
        <p id ="book-count"></p>
        <p id ="book-page-num"></p>
        <p id ="book-rate-min"></p>
        <p id ="book-rate-max"></p>
        <p id ="book-rate-avg"></p>
</div>
</div>

<div class="clear"></div>


<script> 
var h = 2000,
    w = 500,
    margin = 15,
    cols = 10;

var svg = d3.select('#books-2013')
    .attr('height', h)
    .attr('width', w);

//Scale
var x = d3.scale.linear().domain([0,cols]).range([margin, w - margin]);
var y = d3.scale.linear().domain([0,40]).range([margin, h - margin]);
var color = d3.scale.linear().domain([0, 700]).range(['#FFB6C1','#7D1717']);

var books = null;

d3.json('books.json', function(err,data){
    books=data;
    drawYear(2013,books[2013]);
})

function drawYear(year, data) {
    d3.selectAll('h1').attr('class', "")
    d3.select("#year-"+year).attr('class',"selected-year");

    d3.select('#book-count').text("This set has " +data.meta.count + " books.");
    d3.select('#book-page-num').text("Totalling "+ data.meta.pages + " pages.");
    d3.select('#book-rate-min').text("The worst of these was rated: "+data.meta.rating.min);
    d3.select('#book-rate-max').text("The best of these was rated: "+data.meta.rating.max);
    d3.select('#book-rate-avg').text("The average Goodreads rating for all of these books is: "+data.meta.rating.avg);

    var data = svg.selectAll('circle')
        .data(data.books, function(d,idx){
            return d.title + "-" + d.year;
        });
        
        data.exit().remove()
        data.enter()//any new datapoint

        .append('circle')
            .attr('r', 10)
            .attr('cx', function(d, idx){ //d is a book (special coloring would go here), idx is the index
                return x(idx % cols);
            })
            .attr('cy', function(d,idx){
                return y(Math.floor(idx / cols));
            })
            .attr('fill', function(d){
                return color(d.num_pages);

            })
            .on('mouseover',function(d){
                d3.select('#book-title').text(d.title);
                d3.select('#book-image').attr('src', d.image_url);
                d3.select('#book-author').text("by " + d.author);
                d3.select('#book-num_pages').text(d.num_pages + " pages");
                d3.select(this).attr('fill', 'red');
                d3.select('#book-count').text("");
                d3.select('#book-page-num').text("");
                d3.select('#book-rate-min').text("");
                d3.select('#book-rate-max').text("");
                d3.select('#book-rate-avg').text("");
                
            })

            .on('mouseout', function(d){
                d3.select('#book-title').text('');
                d3.select('#book-image').attr('src','');
                d3.select('#book-author').text('');
                d3.select('#book-num_pages').text('');
                d3.select(this).attr('fill', color(d.num_pages));
                d3.select('#book-count').text("This set has " +data.meta.count + " books.");
                d3.select('#book-page-num').text("Totalling "+ data.meta.pages + " pages.");
                d3.select('#book-rate-min').text("The worst of these was rated: "+data.meta.rating.min);
                d3.select('#book-rate-max').text("The best of these was rated: "+data.meta.rating.max);
                d3.select('#book-rate-avg').text("The average Goodreads rating for all of these books is: "+data.meta.rating.avg);
            })

            .on('click', function(d){
                window.location=d.link;
            });

    console.log(books);
}


d3.select('#year-all').on('click',function(){
    if (!books['all']){
        books['all'] = {
            meta: {
                count: 0,
                pages: 0,
                rating: {
                    min: null,
                    avg: 0,
                    max: null,
                }
            },
            books: []
        };

        [2009,2010,2011,2012,2013] .forEach(function(year){
            books.all.meta.pages += books[year].meta.pages
            books.all.meta.count += books[year].meta.count
            books.all.books = books.all.books.concat(books[year].books)
        })
        


    }
    drawYear('all', books['all'])

})

d3.select('#year-2013').on('click',function(){ drawYear(2013,books[2013]); });
d3.select('#year-2012').on('click',function(){ drawYear(2012,books[2012]); });
d3.select('#year-2011').on('click',function(){ drawYear(2011,books[2011]); });
d3.select('#year-2010').on('click',function(){ drawYear(2010,books[2010]); });
d3.select('#year-2009').on('click',function(){ drawYear(2009,books[2009]); });
d3.select('#year-2008').on('click',function(){ drawYear(2008,books[2008]); });
d3.select('#year-pre-2008').on('click',function(){ drawYear('pre-2008',books['pre-2008']); });
d3.select('#fiction').on('click',function(){ drawYear('fiction',books['fiction']); });
d3.select('#non-fiction').on('click',function(){ drawYear('nonfiction',books['nonfiction']); });
d3.select('#female-author').on('click',function(){ drawYear('female_author',books['female_author']); });
d3.select('#male-author').on('click',function(){ drawYear('male_author',books['male_author']); });

</script>
</body>
</html>